<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS MAGNUS FINAL</title>
    <style>
        /* 
         * =========================================
         * CSS VARIABLES & THEME DEFINITIONS
         * =========================================
         */
        :root {
            --text-color: #ffffff;
            --background-dark: #121212;
            
            /* Gradient Definitions */
            --gold-gradient: linear-gradient(135deg, #ffd700, #ff8c00);
            --blue-gradient: linear-gradient(135deg, #00c6ff, #0072ff);
            --pink-gradient: linear-gradient(135deg, #ff758c, #ff7eb3);
            --green-gradient: linear-gradient(135deg, #11998e, #38ef7d);
            --orange-gradient: linear-gradient(135deg, #f12711, #f5af19);
            
            /* Glassmorphism Variables */
            --glass-bg: rgba(30, 30, 30, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-blur: blur(15px);
        }

        /* 
         * =========================================
         * BODY & GLOBAL STYLES
         * =========================================
         */
        body {
            /* Animated Deep Space Background */
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #101010);
            background-size: 400% 400%;
            animation: backgroundAnimation 15s ease infinite;
            
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevents scroll on body, uses flex container */
        }

        @keyframes backgroundAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 
         * =========================================
         * HEADER SECTION
         * =========================================
         */
        .app-header {
            padding: 15px;
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            font-size: 20px;
            font-weight: 900;
            letter-spacing: 3px;
            
            /* Gradient Text Effect */
            background-image: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            flex-shrink: 0; /* Header size fixed */
        }

        /* 
         * =========================================
         * MAIN CONTENT AREA
         * =========================================
         */
        .main-content {
            flex: 1;
            overflow-y: auto; /* Allows scrolling inside this container */
            padding: 20px;
            padding-bottom: 100px; /* Space for Bottom Nav */
        }

        /* View Sections (Tabs) */
        .view-section {
            display: none;
            animation: slideUpAnimation 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .view-section.active {
            display: block;
        }

        @keyframes slideUpAnimation {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 
         * =========================================
         * WIDGETS & CARDS STYLING
         * =========================================
         */
        .widget-card, .input-container, .cloud-container {
            background: linear-gradient(145deg, rgba(40, 40, 40, 0.6), rgba(20, 20, 20, 0.8));
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: var(--glass-border);
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            padding: 0; /* Reset padding for internal control */
        }

        /* 
         * =========================================
         * DASHBOARD COMPONENTS
         * =========================================
         */
        .trading-widget-wrapper {
            height: 200px;
            width: 100%;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .news-section-header {
            font-size: 13px;
            color: #aaaaaa;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            padding-left: 5px;
            font-weight: bold;
        }

        .news-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 12px;
            border-left: 4px solid #ff8c00;
            transition: transform 0.2s ease, background 0.2s;
            cursor: pointer;
        }

        .news-item:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.1);
        }

        .news-timestamp {
            font-size: 10px;
            color: #ff8c00;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .news-headline {
            font-size: 15px;
            font-weight: 500;
            line-height: 1.4;
            color: #ffffff;
        }

        /* 
         * =========================================
         * PLANER & TASKS COMPONENTS
         * =========================================
         */
        .date-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 20px;
            border-radius: 50px;
            margin-bottom: 25px;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-arrow-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px 15px;
        }

        /* KI Optimize Button - High Visibility */
        .ai-optimize-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(90deg, #FFD700, #FF8C00, #FF0080);
            background-size: 200% 200%;
            animation: gradientMove 4s ease infinite;
            border: none;
            border-radius: 16px;
            color: white;
            font-weight: 800;
            font-size: 15px;
            margin-bottom: 25px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 140, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Input Forms */
        .input-container {
            padding: 20px;
        }

        .input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .styled-input, .styled-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 14px;
            border-radius: 10px;
            width: 100%;
            outline: none;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .styled-input:focus, .styled-select:focus {
            border-color: #ffd700;
            background: rgba(0, 0, 0, 0.5);
        }

        .add-task-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
            font-size: 15px;
            /* White Gradient Button */
            background: linear-gradient(135deg, #ffffff, #aaaaaa);
            color: #000000;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        /* Task List Items */
        .task-list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-card {
            display: flex;
            align-items: center;
            padding: 16px;
            border-radius: 14px;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transition: transform 0.1s;
        }

        /* Category Specific Styles (Gradient Borders & Backgrounds) */
        .category-finanzen {
            border-left: 4px solid #ffd700;
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), transparent);
        }
        .category-schule {
            border-left: 4px solid #00c6ff;
            background: linear-gradient(90deg, rgba(0, 198, 255, 0.15), transparent);
        }
        .category-sport {
            border-left: 4px solid #ff758c;
            background: linear-gradient(90deg, rgba(255, 117, 140, 0.15), transparent);
        }
        .category-freizeit {
            border-left: 4px solid #38ef7d;
            background: linear-gradient(90deg, rgba(56, 239, 125, 0.15), transparent);
        }
        .category-hausarbeit {
            border-left: 4px solid #f12711;
            background: linear-gradient(90deg, rgba(241, 39, 17, 0.15), transparent);
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #666;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
            background: rgba(0,0,0,0.3);
        }

        .task-checkbox.checked {
            background: #ffd700;
            border-color: #ffd700;
            color: black;
            box-shadow: 0 0 10px #ffd700;
        }

        .task-details {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .task-title-text {
            font-size: 16px;
            margin-bottom: 5px;
            display: block;
            font-weight: 500;
        }

        .task-metadata {
            font-size: 11px;
            color: #aaaaaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .meta-tag {
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
        }

        .delete-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 20px;
            padding: 10px;
            cursor: pointer;
            margin-left: 5px;
        }

        /* 
         * =========================================
         * TAGEBUCH (DIARY) STYLES
         * =========================================
         */
        #diary-textarea {
            width: 100%;
            height: 70vh;
            background: transparent;
            border: none;
            color: #e0e0e0;
            padding: 20px;
            font-size: 17px;
            line-height: 1.6;
            resize: none;
            outline: none;
            font-family: inherit;
        }

        /* 
         * =========================================
         * CLOUD SYNC STYLES
         * =========================================
         */
        .cloud-container {
            padding: 25px;
            text-align: center;
        }

        .cloud-action-btn {
            width: 100%;
            padding: 16px;
            margin-top: 15px;
            border-radius: 12px;
            border: none;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: white;
            font-weight: bold;
            transition: transform 0.1s;
        }

        .cloud-action-btn:active {
            transform: scale(0.98);
        }

        .btn-upload {
            background: linear-gradient(135deg, #434343, #000000);
            border: 1px solid #333;
        }

        .btn-download {
            background: var(--gold-gradient);
            color: black;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }

        /* 
         * =========================================
         * BOTTOM NAVIGATION BAR
         * =========================================
         */
        .bottom-navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 12px 0 30px 0; /* Extra padding for iOS swipe bar */
            z-index: 2000;
        }

        .nav-item-btn {
            background: none;
            border: none;
            color: #666666;
            font-size: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 60px;
        }

        .nav-item-btn.active {
            color: #ffd700;
            transform: translateY(-5px);
        }

        .nav-item-btn.active .nav-icon {
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }

    </style>
</head>
<body>

    <!-- 
      HEADER 
    -->
    <header class="app-header">
        NEXUS MAGNUS
    </header>

    <!-- 
      MAIN CONTENT CONTAINER 
    -->
    <div class="main-content">

        <!-- 
          VIEW 1: DASHBOARD (NEWS & TRADING) 
        -->
        <div id="view-dashboard" class="view-section active">
            
            <!-- TRADING VIEW WIDGET -->
            <div class="widget-card">
                <div class="trading-widget-wrapper">
                    <!-- TradingView Widget BEGIN -->
                    <div class="tradingview-widget-container">
                        <div class="tradingview-widget-container__widget"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                        {
                        "symbols": [
                            { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                            { "proName": "FOREXCOM:NSXUSD", "title": "Nasdaq" },
                            { "proName": "FX_IDC:EURUSD", "title": "EUR/USD" },
                            { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" },
                            { "description": "Gold", "proName": "TVC:GOLD" },
                            { "description": "Dax", "proName": "XETR:DAX" }
                        ],
                        "showSymbolLogo": true,
                        "colorTheme": "dark",
                        "isTransparent": true,
                        "displayMode": "adaptive",
                        "locale": "de_DE"
                        }
                        </script>
                    </div>
                    <!-- TradingView Widget END -->
                </div>
            </div>

            <!-- NEWS FEED -->
            <h3 class="news-section-header">TAGESSCHAU WORLD FEED</h3>
            <div id="news-feed-container">
                <div style="padding:20px; text-align:center; color:#666;">Verbinde mit Welt-Server...</div>
            </div>
        </div>

        <!-- 
          VIEW 2: PLANER (TASKS & KI) 
        -->
        <div id="view-planer" class="view-section">
            
            <!-- DATE CONTROLS -->
            <div class="date-navigation">
                <button class="nav-arrow-btn" onclick="changeDate(-1)">‚óÄ</button>
                <span id="date-display-text">Heute</span>
                <button class="nav-arrow-btn" onclick="changeDate(1)">‚ñ∂</button>
            </div>

            <!-- KI OPTIMIZE BUTTON -->
            <button class="ai-optimize-btn" onclick="runAiOptimization()">
                ‚ú® KI: Tag Optimieren
            </button>

            <!-- TASK INPUT FORM -->
            <div class="input-container">
                <input type="text" id="input-task-title" class="styled-input" placeholder="Neue Mission eingeben..." style="margin-bottom:15px;">
                
                <div class="input-row">
                    <input type="time" id="input-task-time" class="styled-input">
                    <select id="input-task-category" class="styled-select">
                        <option value="finanzen">Finanzen üí∞</option>
                        <option value="schule">Schule üìö</option>
                        <option value="sport">Sport üèãÔ∏è</option>
                        <option value="freizeit">Freizeit üéÆ</option>
                        <option value="hausarbeit">Hausarbeit üßπ</option>
                    </select>
                </div>
                
                <div style="display:flex; align-items:center; gap:10px; font-size:13px; color:#aaa; margin-left:5px;">
                    <input type="checkbox" id="input-task-daily" style="width:18px; height:18px;"> 
                    <label for="input-task-daily">T√§glich wiederholen</label>
                </div>
                
                <button class="add-task-btn" onclick="addNewTask()">Hinzuf√ºgen</button>
            </div>

            <!-- TASK LIST -->
            <div id="task-list-output" class="task-list-container">
                <!-- Tasks will be injected here by JavaScript -->
            </div>
        </div>

        <!-- 
          VIEW 3: TAGEBUCH (DIARY) 
        -->
        <div id="view-diary" class="view-section">
            <div class="widget-card" style="min-height: 75vh;">
                <textarea id="diary-textarea" placeholder="Liebes Tagebuch, heute habe ich..." oninput="saveAppDataToLocal()"></textarea>
            </div>
        </div>

        <!-- 
          VIEW 4: CLOUD SYNC 
        -->
        <div id="view-cloud" class="view-section">
            <div class="cloud-container">
                <h3 style="margin-top:0; color:#ffd700; margin-bottom: 20px;">Secure Sync Center</h3>
                
                <input type="password" id="cloud-api-key" class="styled-input" placeholder="X-Master-Key eingeben" style="margin-bottom:15px;" oninput="saveCloudCredentials()">
                <input type="text" id="cloud-bin-id" class="styled-input" placeholder="Bin-ID eingeben" style="margin-bottom:25px;" oninput="saveCloudCredentials()">
                
                <button class="cloud-action-btn btn-upload" onclick="executeCloudUpload()">
                    ‚òÅÔ∏è Upload Data to Cloud
                </button>
                <button class="cloud-action-btn btn-download" onclick="executeCloudDownload()">
                    ‚¨á Download Data from Cloud
                </button>
            </div>
            
            <div style="text-align:center; margin-top:20px; font-size:12px; opacity:0.5; color: #888;">
                Nexus Neural Engine v9.0 ‚Ä¢ Credentials Auto-Save Enabled
            </div>
        </div>

    </div>

    <!-- 
      BOTTOM NAVIGATION 
    -->
    <nav class="bottom-navbar">
        <button class="nav-item-btn active" onclick="switchView('dashboard', this)">
            <span class="nav-icon">üìä</span>
            <span>Info</span>
        </button>
        <button class="nav-item-btn" onclick="switchView('planer', this)">
            <span class="nav-icon">üìÖ</span>
            <span>Planer</span>
        </button>
        <button class="nav-item-btn" onclick="switchView('diary', this)">
            <span class="nav-icon">üìñ</span>
            <span>Tagebuch</span>
        </button>
        <button class="nav-item-btn" onclick="switchView('cloud', this)">
            <span class="nav-icon">‚òÅÔ∏è</span>
            <span>Cloud</span>
        </button>
    </nav>

    <!-- 
      JAVASCRIPT LOGIC 
    -->
    <script>
        /**
         * GLOBAL VARIABLES & STATE
         */
        let appData = {
            tasks: [],
            diaryEntries: {}
        };
        let currentSelectedDate = new Date();

        /**
         * INITIALIZATION ON WINDOW LOAD
         */
        window.onload = function() {
            // 1. Load Data from LocalStorage
            const storedData = localStorage.getItem('nexus_magnus_ultimate_data');
            if (storedData) {
                try {
                    appData = JSON.parse(storedData);
                } catch (e) {
                    console.error("Data corruption detected", e);
                    appData = { tasks: [], diaryEntries: {} };
                }
            }

            // 2. Load Cloud Credentials (NEW FEATURE)
            const savedKey = localStorage.getItem('nexus_saved_key');
            const savedBin = localStorage.getItem('nexus_saved_bin');
            if(savedKey) document.getElementById('cloud-api-key').value = savedKey;
            if(savedBin) document.getElementById('cloud-bin-id').value = savedBin;

            // 3. Perform Checks
            performDailyTaskReset();
            
            // 4. Render UI Components
            updateDateHeaderDisplay();
            fetchTagesschauNews();

            // 5. Set Interval for News Updates (Every 10 minutes)
            setInterval(fetchTagesschauNews, 600000);
        };

        /**
         * CREDENTIAL MANAGEMENT (NEW FEATURE)
         */
        function saveCloudCredentials() {
            const key = document.getElementById('cloud-api-key').value;
            const bin = document.getElementById('cloud-bin-id').value;
            localStorage.setItem('nexus_saved_key', key);
            localStorage.setItem('nexus_saved_bin', bin);
        }

        /**
         * NAVIGATION FUNCTIONALITY
         */
        function switchView(viewName, buttonElement) {
            // Hide all views
            const views = document.querySelectorAll('.view-section');
            views.forEach(view => view.classList.remove('active'));

            // Show selected view
            const targetView = document.getElementById('view-' + viewName);
            if (targetView) {
                targetView.classList.add('active');
            }

            // Update Bottom Nav Styling
            const navButtons = document.querySelectorAll('.nav-item-btn');
            navButtons.forEach(btn => btn.classList.remove('active'));
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Specific refresh actions
            if (viewName === 'diary') {
                loadDiaryEntryForDate();
            }
        }

        /**
         * DATE MANAGEMENT
         */
        function getFormattedDateKey(dateObj) {
            // Returns YYYY-MM-DD format for storage keys
            return dateObj.toISOString().split('T')[0];
        }

        function updateDateHeaderDisplay() {
            const options = { weekday: 'short', day: 'numeric', month: 'long', year: 'numeric' };
            const dateString = currentSelectedDate.toLocaleDateString('de-DE', options);
            document.getElementById('date-display-text').innerText = dateString;
            
            // Re-render content dependent on date
            renderTaskList();
            loadDiaryEntryForDate();
        }

        function changeDate(daysToAdd) {
            currentSelectedDate.setDate(currentSelectedDate.getDate() + daysToAdd);
            updateDateHeaderDisplay();
        }

        /**
         * TASK MANAGEMENT SYSTEM
         */
        function addNewTask() {
            const titleInput = document.getElementById('input-task-title');
            const timeInput = document.getElementById('input-task-time');
            const categoryInput = document.getElementById('input-task-category');
            const dailyInput = document.getElementById('input-task-daily');

            const titleValue = titleInput.value.trim();
            
            if (!titleValue) {
                alert("Bitte gib einen Titel f√ºr die Aufgabe ein.");
                return;
            }

            // Create Task Object
            const newTask = {
                id: Date.now(), // Unique ID
                dateKey: getFormattedDateKey(currentSelectedDate),
                title: titleValue,
                time: timeInput.value,
                category: categoryInput.value,
                isDaily: dailyInput.checked,
                isDone: false,
                lastDoneDate: null
            };

            // Add to Array
            appData.tasks.push(newTask);

            // Clear Input
            titleInput.value = "";
            
            // Save & Render
            saveAppDataToLocal();
            renderTaskList();
        }

        function toggleTaskStatus(taskId) {
            const taskIndex = appData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                const task = appData.tasks[taskIndex];
                task.isDone = !task.isDone;

                // Handle Daily Reset Logic
                if (task.isDaily && task.isDone) {
                    task.lastDoneDate = getFormattedDateKey(new Date());
                }

                saveAppDataToLocal();
                renderTaskList();
            }
        }

        function deleteTask(taskId) {
            if (confirm("M√∂chtest du diese Aufgabe wirklich l√∂schen?")) {
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                saveAppDataToLocal();
                renderTaskList();
            }
        }

        function renderTaskList() {
            const container = document.getElementById('task-list-output');
            container.innerHTML = ""; // Clear current list

            const currentDateKey = getFormattedDateKey(currentSelectedDate);

            // Filter Logic: Show task if it matches current date OR is a daily recurring task
            let filteredTasks = appData.tasks.filter(task => {
                return task.dateKey === currentDateKey || task.isDaily;
            });

            // Sort Logic: By Time
            filteredTasks.sort((a, b) => {
                const timeA = a.time || "23:59";
                const timeB = b.time || "23:59";
                return timeA.localeCompare(timeB);
            });

            if (filteredTasks.length === 0) {
                container.innerHTML = "<div style='text-align:center; opacity:0.5; margin-top:30px;'>Keine Missionen f√ºr diesen Tag.</div>";
                return;
            }

            // Generate HTML for each task
            filteredTasks.forEach(task => {
                // Create Card Element
                const card = document.createElement('div');
                card.className = `task-card category-${task.category}`;
                
                // Opacity if done
                if (task.isDone) {
                    card.style.opacity = "0.5";
                }

                // Checkbox HTML
                const checkState = task.isDone ? 'checked' : '';
                const checkSymbol = task.isDone ? '‚úî' : '';

                // Daily Badge HTML
                const dailyBadge = task.isDaily ? '<span class="meta-tag" style="background:#ffd700; color:black; font-weight:bold;">‚Üª Daily</span>' : '';

                card.innerHTML = `
                    <div class="task-checkbox ${checkState}" onclick="toggleTaskStatus(${task.id})">
                        ${checkSymbol}
                    </div>
                    <div class="task-details">
                        <span class="task-title-text" style="text-decoration: ${task.isDone ? 'line-through' : 'none'}">
                            ${task.title}
                        </span>
                        <div class="task-metadata">
                            <span class="meta-tag">üïë ${task.time || 'Ganzt√§gig'}</span>
                            <span class="meta-tag">${task.category.toUpperCase()}</span>
                            ${dailyBadge}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteTask(${task.id})">‚úï</button>
                `;

                container.appendChild(card);
            });
        }

        function performDailyTaskReset() {
            const todayKey = getFormattedDateKey(new Date());
            let hasChanges = false;

            appData.tasks.forEach(task => {
                if (task.isDaily) {
                    // If the last time it was done is NOT today, reset it to not done
                    if (task.lastDoneDate !== todayKey) {
                        if (task.isDone === true) {
                            task.isDone = false;
                            hasChanges = true;
                        }
                    }
                }
            });

            if (hasChanges) {
                saveAppDataToLocal();
            }
        }

        /**
         * KI OPTIMIZATION ENGINE
         */
        function runAiOptimization() {
            const currentDateKey = getFormattedDateKey(currentSelectedDate);
            
            // Get relevant tasks
            let activeTasks = appData.tasks.filter(t => t.dateKey === currentDateKey || t.isDaily);
            
            if (activeTasks.length === 0) {
                alert("KI Status: Dein Tag ist leer. Bitte f√ºge erst Aufgaben hinzu, damit ich sie optimieren kann.");
                return;
            }

            // Analysis Variables
            let categoriesPresent = activeTasks.map(t => t.category);
            let aiMessages = [];
            let newSuggestions = [];

            // RULE 1: Sport Check
            if (!categoriesPresent.includes('sport')) {
                aiMessages.push("‚ö† K√ñRPERLICHE WARNUNG: Kein Sport erkannt.");
                newSuggestions.push({
                    title: "KI: 20min Home Workout",
                    time: "18:00",
                    category: "sport"
                });
            }

            // RULE 2: School Balance
            const schoolCount = activeTasks.filter(t => t.category === 'schule').length;
            if (schoolCount > 2 && !categoriesPresent.includes('freizeit')) {
                aiMessages.push("‚ö† STRESS LEVEL HOCH: Viel Schule, keine Freizeit.");
                newSuggestions.push({
                    title: "KI: Aktive Gehirn-Pause",
                    time: "16:00",
                    category: "freizeit"
                });
            }

            // RULE 3: Empty Day Check
            if (activeTasks.length < 3) {
                aiMessages.push("‚Ñπ LEERLAUF ERKANNT: Zeit f√ºr Produktivit√§t.");
                newSuggestions.push({
                    title: "KI: Finanzen & Portfolio Check",
                    time: "19:00",
                    category: "finanzen"
                });
            }

            // Output Result
            let resultMessage = "KI ANALYSE BERICHT:\n-------------------\n";
            if (aiMessages.length > 0) {
                resultMessage += aiMessages.join("\n");
                resultMessage += "\n\n>> Ich f√ºge automatisch optimierte Aufgaben hinzu.";
                alert(resultMessage);

                // Add suggested tasks
                newSuggestions.forEach(suggestion => {
                    appData.tasks.push({
                        id: Date.now() + Math.random(),
                        dateKey: currentDateKey,
                        title: suggestion.title,
                        time: suggestion.time,
                        category: suggestion.category,
                        isDaily: false,
                        isDone: false,
                        lastDoneDate: null
                    });
                });

                saveAppDataToLocal();
                renderTaskList();

            } else {
                alert("KI Status: ‚úÖ Dein Plan sieht perfekt aus. Gute Balance. Keine Optimierung n√∂tig.");
            }
        }

        /**
         * DIARY SYSTEM
         */
        function loadDiaryEntryForDate() {
            const key = getFormattedDateKey(currentSelectedDate);
            const entry = appData.diaryEntries[key] || "";
            document.getElementById('diary-textarea').value = entry;
        }

        function saveAppDataToLocal() {
            // Update Diary State before saving
            const key = getFormattedDateKey(currentSelectedDate);
            const diaryContent = document.getElementById('diary-textarea').value;
            
            // Only save diary if view is active or we are sure (input listener handles this)
            if (diaryContent !== undefined) {
                 appData.diaryEntries[key] = diaryContent;
            }

            // Write to Storage
            localStorage.setItem('nexus_magnus_ultimate_data', JSON.stringify(appData));
        }

        /**
         * NEWS SYSTEM (Tagesschau RSS via Proxy)
         */
        async function fetchTagesschauNews() {
            const container = document.getElementById('news-feed-container');
            const rssUrl = 'https://www.tagesschau.de/infoservices/alle-meldungen-100~rss2.xml';
            const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    let htmlContent = "";
                    // Take first 5 items
                    data.items.slice(0, 5).forEach(item => {
                        // Format Time
                        let timeString = "";
                        if (item.pubDate) {
                            const dateObj = new Date(item.pubDate);
                            timeString = dateObj.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'});
                        }

                        htmlContent += `
                            <div class="news-item" onclick="window.open('${item.link}', '_blank')">
                                <span class="news-timestamp">${timeString} ‚Ä¢ TAGESSCHAU</span>
                                <div class="news-headline">${item.title}</div>
                            </div>
                        `;
                    });
                    container.innerHTML = htmlContent;
                } else {
                    throw new Error("API Status not ok");
                }
            } catch (error) {
                console.error("News Error:", error);
                container.innerHTML = "<div style='padding:20px; text-align:center; color:#ff8c00;'>News Feed Offline (Verbindung pr√ºfen).</div>";
            }
        }

        /**
         * CLOUD SYNC SYSTEM (JSONBIN.IO)
         */
        async function executeCloudUpload() {
            const apiKey = document.getElementById('cloud-api-key').value;
            const binId = document.getElementById('cloud-bin-id').value;
            
            if (!apiKey || !binId) {
                alert("‚ùå FEHLER: Bitte gib erst deinen Master-Key und die Bin-ID ein.");
                return;
            }

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': apiKey
                    },
                    body: JSON.stringify(appData)
                });

                if (response.ok) {
                    alert("‚úÖ UPLOAD ERFOLGREICH: Deine Daten sind sicher in der Cloud.");
                } else {
                    alert("‚ùå UPLOAD FEHLGESCHLAGEN: Pr√ºfe deinen Key.");
                }
            } catch (error) {
                alert("‚ùå NETZWERK FEHLER: " + error.message);
            }
        }

        async function executeCloudDownload() {
            const apiKey = document.getElementById('cloud-api-key').value;
            const binId = document.getElementById('cloud-bin-id').value;
            
            if (!apiKey || !binId) {
                alert("‚ùå FEHLER: Bitte gib erst deinen Master-Key und die Bin-ID ein.");
                return;
            }

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': apiKey
                    }
                });

                if (response.ok) {
                    const json = await response.json();
                    appData = json.record;
                    
                    // Refresh UI completely
                    saveAppDataToLocal();
                    updateDateHeaderDisplay();
                    renderTaskList();
                    alert("‚úÖ DOWNLOAD ERFOLGREICH: Daten wurden wiederhergestellt.");
                } else {
                    alert("‚ùå DOWNLOAD FEHLGESCHLAGEN: Pr√ºfe deinen Key.");
                }
            } catch (error) {
                alert("‚ùå NETZWERK FEHLER: " + error.message);
            }
        }

    </script>
</body>
</html>
