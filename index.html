<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEXUS MAGNUS</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #ffffff;
            --gold: #ffd700;   /* Finanzen */
            --blue: #2196f3;   /* Schule */
            --pink: #ff4081;   /* Sport */
            --green: #00e676;  /* Freizeit */
            --orange: #ff9100; /* Hausarbeit */
            --glass: rgba(30, 30, 30, 0.95);
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        .header {
            padding: 15px;
            background: rgba(20,20,20,0.95);
            border-bottom: 1px solid #333;
            text-align: center;
            font-size: 18px; font-weight: 900; letter-spacing: 2px;
            color: var(--gold);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-btn { background:none; border:none; font-size:18px; cursor:pointer; }

        /* --- CONTENT AREA --- */
        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px);} to{opacity:1;transform:translateY(0);} }

        /* --- DASHBOARD VIEW --- */
        .widget-container {
            height: 150px; border-radius: 12px; overflow: hidden; margin-bottom: 20px;
            border: 1px solid #333; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .news-header { font-size: 14px; color: #888; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .news-item {
            background: var(--card); border-left: 3px solid #fff;
            padding: 15px; margin-bottom: 10px; border-radius: 0 8px 8px 0;
        }
        .news-time { font-size: 11px; color: var(--gold); display: block; margin-bottom: 4px; }
        .news-headline { font-size: 15px; font-weight: 500; }

        /* --- PLANER VIEW --- */
        .date-control {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px;
            font-weight: bold; border: 1px solid #333;
        }
        .nav-arrow { background:rgba(255,255,255,0.1); border:none; color:white; width:30px; height:30px; border-radius:50%; cursor:pointer; }

        /* KI BUTTON */
        .ai-opt-btn {
            width: 100%; padding: 15px; 
            background: linear-gradient(135deg, var(--gold), #ff8c00);
            border: none; border-radius: 12px; color: black; font-weight: bold; font-size: 16px;
            margin-bottom: 20px; cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .ai-opt-btn:active { transform: scale(0.98); }

        /* INPUT AREA */
        .input-box {
            background: #1a1a1a; padding: 15px; border-radius: 12px; margin-bottom: 20px;
            border: 1px solid #333;
        }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select {
            background: #000; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px;
            width: 100%; outline: none; font-size: 14px;
        }
        .check-row { display: flex; align-items: center; gap: 10px; color: #aaa; font-size: 13px; }
        .add-btn {
            background: #333; color: white; width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: bold; margin-top: 10px; cursor: pointer;
        }

        /* TASKS */
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-card {
            display: flex; align-items: center; padding: 15px; border-radius: 10px;
            background: var(--card); border: 1px solid #333; position: relative;
        }
        /* Color Logic */
        .c-finanzen { border-left: 4px solid var(--gold); box-shadow: inset 10px 0 20px -15px rgba(255, 215, 0, 0.4); }
        .c-schule { border-left: 4px solid var(--blue); box-shadow: inset 10px 0 20px -15px rgba(33, 150, 243, 0.4); }
        .c-sport { border-left: 4px solid var(--pink); box-shadow: inset 10px 0 20px -15px rgba(255, 64, 129, 0.4); }
        .c-freizeit { border-left: 4px solid var(--green); box-shadow: inset 10px 0 20px -15px rgba(0, 230, 118, 0.4); }
        .c-hausarbeit { border-left: 4px solid var(--orange); box-shadow: inset 10px 0 20px -15px rgba(255, 145, 0, 0.4); }

        .checkbox {
            width: 24px; height: 24px; border: 2px solid #555; border-radius: 50%; margin-right: 15px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        .checkbox.checked { background: var(--gold); border-color: var(--gold); color: black; }
        .task-info { flex: 1; }
        .task-title { font-size: 15px; margin-bottom: 3px; display: block; }
        .task-meta { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- TAGEBUCH VIEW --- */
        #diary-input {
            width: 100%; height: 60vh; background: var(--card); border: 1px solid #333;
            color: #ccc; padding: 20px; font-size: 16px; line-height: 1.6; border-radius: 12px;
            resize: none; outline: none; box-sizing: border-box;
        }

        /* --- CLOUD VIEW --- */
        .cloud-box {
            background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #333; text-align: center;
        }
        .cloud-btn {
            width: 100%; padding: 15px; margin-top: 10px; border-radius: 8px; border: none; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-up { background: #333; color: white; border: 1px solid #555; }
        .btn-down { background: var(--gold); color: black; font-weight: bold; }

        /* --- NAVIGATION --- */
        .navbar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #0f0f0f; border-top: 1px solid #333;
            display: flex; justify-content: space-around; padding: 12px 0 25px 0;
            z-index: 200;
        }
        .nav-item {
            background: none; border: none; color: #666; font-size: 10px;
            display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer;
        }
        .nav-item.active { color: var(--gold); }
        .nav-icon { font-size: 20px; }

    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <span>NEXUS MAGNUS</span>
        <div style="font-size:12px; font-weight:normal; color:#666;">v.Final</div>
    </div>

    <!-- CONTENT -->
    <div class="content">

        <!-- 1. DASHBOARD -->
        <div id="view-dashboard" class="view-section active">
            <!-- Funktionierendes TradingView Widget -->
            <div class="widget-container">
                <!-- TradingView Widget BEGIN -->
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                    {
                    "symbols": [
                        { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                        { "proName": "FOREXCOM:NSXUSD", "title": "US 100" },
                        { "proName": "FX_IDC:EURUSD", "title": "EUR/USD" },
                        { "proName": "BITSTAMP:BTCUSD", "title": "Bitcoin" },
                        { "description": "Gold", "proName": "TVC:GOLD" },
                        { "description": "Dax", "proName": "XETR:DAX" }
                    ],
                    "showSymbolLogo": true,
                    "colorTheme": "dark",
                    "isTransparent": false,
                    "displayMode": "adaptive",
                    "locale": "de_DE"
                    }
                    </script>
                </div>
                <!-- TradingView Widget END -->
            </div>

            <h3 class="news-header">TAGESSCHAU LIVE TICKER</h3>
            <div id="news-container">
                <div style="padding:20px; text-align:center; color:#666;">Lade Nachrichten...</div>
            </div>
        </div>

        <!-- 2. PLANER -->
        <div id="view-planer" class="view-section">
            <div class="date-control">
                <button class="nav-arrow" onclick="changeDate(-1)">‚óÄ</button>
                <span id="date-display">Heute</span>
                <button class="nav-arrow" onclick="changeDate(1)">‚ñ∂</button>
            </div>

            <button class="ai-opt-btn" onclick="optimizeDay()">
                ‚ö° KI: Tag optimieren & analysieren
            </button>

            <div class="input-box">
                <input type="text" id="t-title" placeholder="Aufgabe eingeben..." style="margin-bottom:10px;">
                <div class="row">
                    <input type="time" id="t-time">
                    <select id="t-cat">
                        <option value="finanzen">Finanzen üí∞</option>
                        <option value="schule">Schule üìö</option>
                        <option value="sport">Sport üèãÔ∏è</option>
                        <option value="freizeit">Freizeit üéÆ</option>
                        <option value="hausarbeit">Hausarbeit üßπ</option>
                    </select>
                </div>
                <div class="check-row">
                    <input type="checkbox" id="t-daily" style="width:auto;"> 
                    <label for="t-daily">T√§glich wiederholen</label>
                </div>
                <button class="add-btn" onclick="addTask()">Hinzuf√ºgen</button>
            </div>

            <div id="task-list" class="task-list"></div>
        </div>

        <!-- 3. TAGEBUCH -->
        <div id="view-diary" class="view-section">
            <h3 style="margin-top:0;">Tagebuch</h3>
            <textarea id="diary-input" placeholder="Was hast du heute erlebt? (Wird automatisch gespeichert)" oninput="saveData()"></textarea>
        </div>

        <!-- 4. CLOUD -->
        <div id="view-cloud" class="view-section">
            <h3 style="margin-top:0;">Cloud Sync Center</h3>
            <p style="color:#666; font-size:13px; margin-bottom:20px;">
                Gib hier deine Zugangsdaten ein. Sie werden tempor√§r f√ºr diese Sitzung gespeichert.
            </p>
            
            <div class="cloud-box">
                <input type="password" id="api-key" placeholder="X-Master-Key eingeben..." style="margin-bottom:10px;">
                <input type="text" id="bin-id" placeholder="Bin-ID eingeben..." style="margin-bottom:20px;">
                
                <button class="cloud-btn btn-up" onclick="uploadCloud()">
                    ‚òÅÔ∏è Upload (Senden)
                </button>
                <button class="cloud-btn btn-down" onclick="downloadCloud()">
                    ‚¨á Download (Laden)
                </button>
            </div>
            
            <div style="margin-top:30px; border-top:1px solid #333; padding-top:20px;">
                <h4 style="margin:0 0 10px 0;">KI Status</h4>
                <div style="background:#222; padding:10px; border-radius:8px; font-size:12px; color:#00e676;">
                    ‚óè Optimierungs-Algorithmus aktiv<br>
                    ‚óè Datenanalyse bereit
                </div>
            </div>
        </div>

    </div>

    <!-- BOTTOM NAVBAR -->
    <div class="navbar">
        <button class="nav-item active" onclick="nav('dashboard', this)">
            <span class="nav-icon">üìä</span> Dashboard
        </button>
        <button class="nav-item" onclick="nav('planer', this)">
            <span class="nav-icon">üìÖ</span> Planer
        </button>
        <button class="nav-item" onclick="nav('diary', this)">
            <span class="nav-icon">üìñ</span> Tagebuch
        </button>
        <button class="nav-item" onclick="nav('cloud', this)">
            <span class="nav-icon">‚òÅÔ∏è</span> Cloud
        </button>
    </div>

    <script>
        // --- DATA STATE ---
        let appData = {
            tasks: [],
            diary: {}
        };
        let currentDate = new Date();
        
        // --- INIT ---
        window.onload = function() {
            // Load local backup
            if(localStorage.getItem('nexus_magnus')) {
                appData = JSON.parse(localStorage.getItem('nexus_magnus'));
            }
            
            // Check recurring tasks
            checkDailyResets();
            
            // Render UI
            updateDateDisplay();
            renderTasks();
            loadNews();
            
            // Auto News Refresh
            setInterval(loadNews, 600000);
        };

        // --- NAVIGATION & DATE ---
        function nav(viewId, btn) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            
            // Refresh content if needed
            if(viewId === 'diary') loadDiary();
        }

        function getDateKey(d) {
            return d.toISOString().split('T')[0];
        }

        function updateDateDisplay() {
            const options = { weekday: 'short', day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('date-display').innerText = currentDate.toLocaleDateString('de-DE', options);
            renderTasks();
            loadDiary();
        }

        function changeDate(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            updateDateDisplay();
        }

        // --- TASKS LOGIC ---
        function addTask() {
            const title = document.getElementById('t-title').value;
            const time = document.getElementById('t-time').value;
            const cat = document.getElementById('t-cat').value;
            const daily = document.getElementById('t-daily').checked;

            if(!title) return alert("Bitte Aufgabe eingeben!");

            appData.tasks.push({
                id: Date.now(),
                date: getDateKey(currentDate),
                title: title,
                time: time,
                cat: cat,
                daily: daily,
                done: false,
                lastDone: null
            });

            // Reset Input
            document.getElementById('t-title').value = "";
            saveData();
            renderTasks();
        }

        function toggleTask(id) {
            const task = appData.tasks.find(t => t.id === id);
            if(task) {
                task.done = !task.done;
                if(task.daily && task.done) {
                    task.lastDone = getDateKey(new Date());
                }
                saveData();
                renderTasks();
            }
        }

        function deleteTask(id) {
            if(confirm("Aufgabe wirklich l√∂schen?")) {
                appData.tasks = appData.tasks.filter(t => t.id !== id);
                saveData();
                renderTasks();
            }
        }

        function checkDailyResets() {
            const today = getDateKey(new Date());
            let changed = false;
            appData.tasks.forEach(t => {
                if(t.daily && t.lastDone !== today) {
                    t.done = false; // Reset daily task for today
                    changed = true;
                }
            });
            if(changed) saveData();
        }

        function renderTasks() {
            const list = document.getElementById('task-list');
            list.innerHTML = "";
            const key = getDateKey(currentDate);

            // Filter tasks: Current Date OR Daily tasks
            let tasksToShow = appData.tasks.filter(t => t.date === key || t.daily);
            
            // Sort by time
            tasksToShow.sort((a, b) => (a.time || "23:59").localeCompare(b.time || "23:59"));

            if(tasksToShow.length === 0) {
                list.innerHTML = "<div style='text-align:center; color:#444; margin-top:20px;'>Keine Aufgaben f√ºr diesen Tag.</div>";
                return;
            }

            tasksToShow.forEach(t => {
                const el = document.createElement('div');
                el.className = `task-card c-${t.cat}`; // Apply color class
                if(t.done) el.style.opacity = "0.5";

                el.innerHTML = `
                    <div class="checkbox ${t.done ? 'checked' : ''}" onclick="toggleTask(${t.id})">
                        ${t.done ? '‚úî' : ''}
                    </div>
                    <div class="task-info">
                        <span class="task-title" style="text-decoration: ${t.done ? 'line-through' : 'none'}">${t.title}</span>
                        <div class="task-meta">
                            ${t.time || '--:--'} ‚Ä¢ ${t.cat.toUpperCase()} ${t.daily ? '‚Ä¢ ‚Üª T√ÑGLICH' : ''}
                        </div>
                    </div>
                    <button onclick="deleteTask(${t.id})" style="background:none; border:none; color:#666; font-size:18px; padding:10px;">√ó</button>
                `;
                list.appendChild(el);
            });
        }

        // --- KI OPTIMIZATION LOGIC (THE BRAIN) ---
        function optimizeDay() {
            const key = getDateKey(currentDate);
            let dayTasks = appData.tasks.filter(t => t.date === key || t.daily);
            
            if(dayTasks.length === 0) return alert("KI: Dein Tag ist leer. F√ºge erst Aufgaben hinzu!");

            // 1. Sortieren
            dayTasks.sort((a, b) => (a.time || "23:59").localeCompare(b.time || "23:59"));
            
            let report = "KI ANALYSE BERICHT:\n------------------\n";
            let suggestions = [];
            
            // 2. Analyse
            let balance = { schule: 0, freizeit: 0, sport: 0 };
            dayTasks.forEach(t => {
                if(t.cat === 'schule') balance.schule++;
                if(t.cat === 'freizeit') balance.freizeit++;
                if(t.cat === 'sport') balance.sport++;
            });

            // 3. Logic Rules
            if(balance.schule > 2 && balance.freizeit === 0) {
                report += "‚ö† WARNUNG: Hohe Schulbelastung ohne Ausgleich.\n‚û° VORSCHLAG: Pause um 16:00 eingef√ºgt.\n";
                suggestions.push({ title: "KI: Aktive Pause", time: "16:00", cat: "freizeit", msg: "L√ºften & Trinken" });
            }
            if(balance.sport === 0) {
                report += "‚ö† HINWEIS: Kein Sport erkannt.\n‚û° VORSCHLAG: Kurzes Workout am Abend.\n";
                suggestions.push({ title: "KI: 15min Workout", time: "19:00", cat: "sport", msg: "Bewegung tut gut" });
            }
            if(dayTasks.length < 3) {
                report += "‚Ñπ INFO: Der Tag ist sehr ruhig.\n‚û° Nutze die Zeit f√ºr Finanzen/Orga.\n";
                suggestions.push({ title: "KI: Portfolio Check", time: "18:00", cat: "finanzen", msg: "Aktien pr√ºfen" });
            }

            // 4. Execute
            alert(report + "\nIch f√ºge die Vorschl√§ge jetzt in deinen Plan ein.");
            
            suggestions.forEach(s => {
                appData.tasks.push({
                    id: Date.now() + Math.random(),
                    date: key,
                    title: s.title,
                    time: s.time,
                    cat: s.cat,
                    daily: false,
                    done: false,
                    isAI: true
                });
            });

            saveData();
            renderTasks();
        }

        // --- DIARY LOGIC ---
        function loadDiary() {
            const key = getDateKey(currentDate);
            document.getElementById('diary-input').value = appData.diary[key] || "";
        }
        function saveData() {
            const key = getDateKey(currentDate);
            const diaryText = document.getElementById('diary-input').value;
            if(diaryText) appData.diary[key] = diaryText;
            
            localStorage.setItem('nexus_magnus', JSON.stringify(appData));
        }

        // --- NEWS LOGIC ---
        async function loadNews() {
            const box = document.getElementById('news-container');
            try {
                // Fetch Tagesschau RSS via Proxy to JSON
                const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.tagesschau.de/infoservices/alle-meldungen-100~rss2.xml');
                const data = await res.json();
                
                let html = "";
                data.items.slice(0, 5).forEach(item => {
                    let time = item.pubDate.split(' ')[1].substring(0,5);
                    html += `
                        <div class="news-item" onclick="window.open('${item.link}', '_blank')">
                            <span class="news-time">${time} ‚Ä¢ TAGESSCHAU</span>
                            <span class="news-headline">${item.title}</span>
                        </div>
                    `;
                });
                box.innerHTML = html;
            } catch(e) {
                console.log(e);
                box.innerHTML = "<div style='padding:20px; text-align:center;'>News offline. Checke Internet.</div>";
            }
        }

        // --- CLOUD SYNC (MANUAL) ---
        async function uploadCloud() {
            const key = document.getElementById('api-key').value;
            const bin = document.getElementById('bin-id').value;
            
            if(!key || !bin) return alert("‚ùå Fehler: Bitte Key & Bin-ID eingeben!");
            
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${bin}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': key
                    },
                    body: JSON.stringify(appData)
                });
                if(res.ok) alert("‚úÖ Erfolgreich hochgeladen!");
                else alert("‚ùå Upload fehlgeschlagen. Key pr√ºfen.");
            } catch(e) { alert("Netzwerkfehler: " + e); }
        }

        async function downloadCloud() {
            const key = document.getElementById('api-key').value;
            const bin = document.getElementById('bin-id').value;
            
            if(!key || !bin) return alert("‚ùå Fehler: Bitte Key & Bin-ID eingeben!");
            
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${bin}/latest`, {
                    method: 'GET',
                    headers: { 'X-Master-Key': key }
                });
                const json = await res.json();
                
                if(json.record) {
                    appData = json.record;
                    saveData();
                    updateDateDisplay();
                    alert("‚úÖ Daten erfolgreich geladen!");
                } else {
                    alert("‚ùå Leere Daten oder falscher Key.");
                }
            } catch(e) { alert("Netzwerkfehler: " + e); }
        }

    </script>
</body>
</html>
